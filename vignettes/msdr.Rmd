---
title: "Mastering Software Development in R"
author: "AH Uyekita"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  
  options(warn=-1)
)
```


```{r,echo=FALSE, message=FALSE, warning=FALSE}
library(magrittr)
library(dplyr)
library(readr)
library(kableExtra)
library(msdr)
library(ggplot2)
```

## Table of Contents

- [1. Introduction](#intro)  
    - [1.1. Timeline Plots](#timeline)
    - [1.2. OpenStreet Maps](#openstreet)
- [2. MSDR Package](#msdr_package)
- [3. Usage](#usage)
    - [3.1. Loading Data](#loading_data)
    - [3.2. My first geom_timeline plot](#first_geom_timeline)




# 1. Introduction {#intro}

This collection of functions aims to enhance the visual experience of earthquakes. There are two kind of functions:

1) Timeline based, and;
2) OpenStreet Maps based.

### Timeline Graphics {#timeline}

Draw a timeline point out each earthquake as a circle, the radius varies according to the magnitude (on Ritcher scale). For each country (or category) there are a dedicated timeline. The user could use the function of annotation to highlight the strongest earthquakes from that database. 

### OpenStreet Maps Plots {#openstreet}

This is an OpenStreet Map based plot, I have used the LONGITUDE and LATITUDE to plot circle as earthquake, which the radius is according to the magnitude (in Ritcher scale). By the using of the `eq_create_label` it is possible to assign for each circle an popup to show several information.

# 2. MSDR Package {#msdr_package}

The functions avaliable in this package:

* eq_clean_data
* eq_create_label
* eq_location_clean
* eq_map
* geom_timeline
* geom_timeline_label
* theme_msdr

A breafly description of each of these functions.

### `eq_clean_data`

This function load a given file_name and then performs the data cleaning. Undercover of this process this functions call the `eq_location_clean` to creates a new column called `LOCATION`.

### `eq_create_label`

Combine three columns to create a new one with `html` structure, this is necessary because the Leaflet package requires the data to be displayed inside of the popup as html format.

### `eq_location_clean`

Adds the `LOCATION` column. The dataset must have the `LOCATION_NAME`. If not the function will not work properly.

### `eq_map`

Draw a OpenStret Map and circles representing the earthquakes location. The popups shows the date of the event.

### `geom_timeline`

Plot a timeline based on magnitude (`EQ_PRIMARY`) and total deaths (`TOTAL_DEATHS`).

### `geom_timeline_label`

Given a plot of `geom_timeline`, this function annotates labels to the `n_max` earthquakes with highest magnitude (`EQ_PRIMARY`).

### `theme_msdr`

A helper function to remove the background, grid, axis thick, etc. Aims to increase the ink ratio of the plot.


There are two more functions, but these two acts hidden.

### `GeomTimeline`

Creates all visuals to be plotted by the geom_timeline.

### `GeomTimelineLabel`

Creates all visuals to be plotted by the geom_timeline_label

For further understanding, I kindly as you to visit the dedicated vignette of each function.

# 3. Usage {#usage}

This package is tailored to work with the NOAA database of earthquake. I have inserted in this package the entire database (downloaded in february/2019), you can access it creating the path and later loading it.

```{r, message=FALSE,warning=FALSE}
# Path to the raw data.
raw_data_path <- system.file("extdata", "signif.txt", package = "msdr")
```

For the sake of this vignette I have used this dataset to perform the desmonstrations.

## 3.1. Loading the NOAA Database {#loading_data}

The loading process could be done using the `eq_clean_data`.

```{r, message=FALSE,warning=FALSE}
# Loading the data.
df_clean <- eq_clean_data(file_name = raw_data_path)
```

After that, the `df_clean` has LOCATION column, LONGITUDE, LATITUDE, etc. converted to the properly class type.

```{r,echo=FALSE}
# Subsetting the df_clean. Showing only data of interest.
df_clean %>% dplyr::select(DATE,
                           COUNTRY, 
                           LOCATION,
                           EQ_PRIMARY,
                           TOTAL_DEATHS) %>% head(10) %>% kableExtra::kable()
```

Table above is an example of the output of the `eq_clean_data`. Bear in mind, I have only converted and cleaned the columns of interest (`LATITUDE`, `LONGITUDE`, `DATE`, `COUNTRY`, `LOCATION`, `EQ_PRIMARY`, and `TOTAL_DEATHS`).

_ATTENTION:_ The `eq_location_clean` works internally of the `eq_clean_data`, as a step of data manipulation.

## 3.2. Creating my first geom_timeline {#first_geom_timeline}

This is a straightforward application of the `geom_timeline` function. Before any plot, I have chosen the asia as my interest of analysis.

```{r,message=FALSE,warning=FALSE,out.width="100%",fig.height=3.5}
# Subsetting the df_clean to select some countries in Asia.
df_asia <- df_clean %>% 
       dplyr::filter(COUNTRY %in% c("INDONESIA","THAILAND", "MYANMAR (BURMA)", "JAPAN"),
                     YEAR > 2000 & YEAR <= 2019)

# Creaing a ggplot object using the geom_timeline.
df_asia %>%
       ggplot2::ggplot() +
              # Defining the aes.
              geom_timeline(aes(x = DATE,
                                y = COUNTRY,
                                size = EQ_PRIMARY,
                                color = TOTAL_DEATHS)) -> tl_asia

# Plotting
tl_asia
```

To enhance the visuals I have created the `theme_msdr`, which removes the background, grids, etc..

```{r,message=FALSE,warning=FALSE,out.width="100%",fig.height=3.5}
# Plotting with tailored theme.
tl_asia + msdr::theme_msdr() -> tl_asia_w_theme

tl_asia_w_theme
```

You can go also further editing the general aspects of the plot using the regular functions of `ggplot2` package. In the example below I have edited the legends' titles.

```{r,message=FALSE,warning=FALSE,out.width="100%",fig.height=3.5}
# Plotting with tailored theme.
tl_asia_w_theme + 
       msdr::theme_msdr() + 
              # Editing the legends' titles 
              labs(color = "# deaths",
                   size = "Richter scale value") -> tl_asia_w_theme_labs

tl_asia_w_theme_labs
```             

## 3.3. Adding annotations

In a way to highlight the strongest events in the given dataframe of analysis. The `geom_timeline_label` is a complementary function to the `geom_timeline`. It will annotate which earthquake from the plot was in the top five (deafult but you can edit it defining a value to `n_max`).

```{r,message=FALSE,warning=FALSE,out.width="100%",fig.height=3.5}
# Plotting with tailored theme.
tl_asia_w_theme_labs +
       # Adding annotations
       geom_timeline_label(aes(x = DATE,
                               label = LOCATION,
                               y = COUNTRY,
                               mag = EQ_PRIMARY,
                               n_max = 10)) -> tl_asia_w_theme_labs_annot

tl_asia_w_theme_labs_annot
``` 

## 3.4. 
